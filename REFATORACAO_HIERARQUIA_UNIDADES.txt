================================================================================
REFATORAÃ‡ÃƒO: HIERARQUIA DE UNIDADES DE ATENDIMENTO
================================================================================
Data: 20 de Fevereiro de 2026
Objetivo: Implementar filtro automÃ¡tico por UnidadeAtendimento baseado em roles
Status: âœ… CONCLUÃDO

================================================================================
1. PROBLEMA IDENTIFICADO
================================================================================

âŒ ANTES:
- Sistema nÃ£o distinguia qual UnidadeAtendimento um GERENTE/ATENDENTE gerenciava
- Token JWT sÃ³ continha: username, roles, nome
- Endpoint /api/unidades-consumo retornava TODAS as unidades (visÃ£o global)
- NÃ£o havia forma de filtrar automaticamente por escopo de atuaÃ§Ã£o

CENÃRIO EXEMPLO:
- Gerente do Restaurante fazia login
- Sistema sabia apenas: "Ã© GERENTE"
- NÃ£o sabia: "Ã© gerente DO RESTAURANTE" vs "Ã© gerente DO BAR"
- Via todas as mesas (restaurante + bar + room service)

================================================================================
2. SOLUÃ‡ÃƒO IMPLEMENTADA
================================================================================

âœ… AGORA:
- Atendente vinculado a uma UnidadeAtendimento especÃ­fica
- Token JWT contÃ©m: username, roles, nome, **unidadeAtendimentoId**
- Novo endpoint: GET /api/unidades-consumo/minhas (filtro automÃ¡tico)
- Filtro baseado em role:
  * ADMIN â†’ vÃª TODAS as unidades (visÃ£o global)
  * GERENTE/ATENDENTE â†’ vÃª APENAS unidades da sua UnidadeAtendimento

================================================================================
3. MUDANÃ‡AS NO CÃ“DIGO
================================================================================

3.1. ENTITY ATENDENTE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/java/com/restaurante/model/entity/Atendente.java

âœ… Adicionado campo:
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "unidade_atendimento_id")
    private UnidadeAtendimento unidadeAtendimento;

Impacto:
- Cada atendente/gerente agora pertence a uma UnidadeAtendimento
- Relacionamento opcional (nullable) para nÃ£o quebrar dados existentes
- Ãndice automÃ¡tico criado pelo JPA

3.2. JWT TOKEN PROVIDER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/java/com/restaurante/security/JwtTokenProvider.java

âœ… Novo mÃ©todo para gerar token com unidade:
    public String generateTokenWithNameAndUnidade(
        String username, 
        String roles, 
        String nome, 
        Long unidadeAtendimentoId
    )

âœ… Novo mÃ©todo para extrair unidade do token:
    public Long getUnidadeAtendimentoIdFromToken(String token)

Token JWT agora contÃ©m:
{
  "sub": "+244923456789",
  "roles": "ROLE_GERENTE",
  "nome": "JoÃ£o Silva",
  "unidadeAtendimentoId": 1,  â† NOVO
  "iat": 1234567890,
  "exp": 1234654290
}

3.3. AUTH SERVICE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/java/com/restaurante/service/AuthService.java

âœ… Atualizado mÃ©todo loginAtendente():
    Long unidadeAtendimentoId = atendente.getUnidadeAtendimento() != null 
        ? atendente.getUnidadeAtendimento().getId() 
        : null;
    
    String token = jwtTokenProvider.generateTokenWithNameAndUnidade(
        atendente.getTelefone(),
        "ROLE_" + atendente.getTipoUsuario().name(),
        atendente.getNome(),
        unidadeAtendimentoId  â† INCLUÃDO
    );

3.4. CONTROLLER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/java/com/restaurante/controller/UnidadeDeConsumoController.java

âœ… Novo endpoint:
    @GetMapping("/minhas")
    public ResponseEntity<ApiResponse<List<UnidadeConsumoResponse>>> listarMinhas()

Endpoints disponÃ­veis:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Endpoint                                â”‚ Comportamento                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GET /api/unidades-consumo               â”‚ Lista TODAS (global)          â”‚
â”‚ GET /api/unidades-consumo/minhas        â”‚ Filtro automÃ¡tico por role    â”‚
â”‚ GET /api/unidades-consumo/unidade-      â”‚ Filtro manual por ID          â”‚
â”‚     atendimento/{id}                    â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3.5. SERVICE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/java/com/restaurante/service/UnidadeDeConsumoService.java

âœ… Novo mÃ©todo listarMinhasUnidades():
    - Verifica role do usuÃ¡rio autenticado
    - Se ADMIN: retorna TODAS as unidades
    - Se GERENTE/ATENDENTE: extrai unidadeAtendimentoId do token
    - Retorna apenas unidades da UnidadeAtendimento do usuÃ¡rio

âœ… MÃ©todos auxiliares:
    - extrairUnidadeAtendimentoIdDoToken()
    - extractTokenFromRequest()

Fluxo de execuÃ§Ã£o:
1. UsuÃ¡rio faz requisiÃ§Ã£o GET /api/unidades-consumo/minhas
2. Service verifica Authentication no SecurityContext
3. Checa se role Ã© ADMIN:
   âœ… Sim â†’ retorna TODAS as unidades
   âŒ NÃ£o â†’ extrai unidadeAtendimentoId do token JWT
4. Filtra unidades por unidadeAtendimentoId
5. Retorna lista filtrada

3.6. MIGRATION SQL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Arquivo: src/main/resources/db/migration/V006__add_unidade_atendimento_to_atendentes.sql

âœ… DDL executado:
    ALTER TABLE atendentes 
    ADD COLUMN unidade_atendimento_id BIGINT;

    ALTER TABLE atendentes 
    ADD CONSTRAINT fk_atendente_unidade_atendimento 
    FOREIGN KEY (unidade_atendimento_id) 
    REFERENCES unidades_atendimento(id);

    CREATE INDEX idx_atendente_unidade_atendimento 
    ON atendentes(unidade_atendimento_id);

================================================================================
4. EXEMPLOS DE USO
================================================================================

4.1. FRONTEND - DETECTAR ROLE E CHAMAR ENDPOINT CORRETO
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Decodifica token para verificar role
const token = localStorage.getItem('token')
const decoded = jwtDecode(token)
const isAdmin = decoded.roles?.includes('ROLE_ADMIN')

// Chama endpoint apropriado
const endpoint = isAdmin 
  ? '/api/unidades-consumo'       // ADMIN: visÃ£o global
  : '/api/unidades-consumo/minhas' // GERENTE: apenas sua unidade

const response = await axios.get(endpoint, {
  headers: { Authorization: `Bearer ${token}` }
})

4.2. CENÃRIO 1: LOGIN COMO GERENTE DO RESTAURANTE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

POST /api/auth/atendente/login
{
  "telefone": "+244923456789",
  "senha": "senha123"
}

RESPONSE:
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "nome": "JoÃ£o Silva",
  "tipoUsuario": "GERENTE"
}

TOKEN DECODIFICADO:
{
  "sub": "+244923456789",
  "roles": "ROLE_GERENTE",
  "nome": "JoÃ£o Silva",
  "unidadeAtendimentoId": 1,  â† UnidadeAtendimento "Restaurante Principal"
  "iat": 1708462800,
  "exp": 1708549200
}

GET /api/unidades-consumo/minhas
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

RESPONSE: Retorna APENAS mesas do Restaurante Principal (ID 1)
[
  { "id": 10, "referencia": "Mesa 10", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } },
  { "id": 15, "referencia": "Mesa 15", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } },
  { "id": 20, "referencia": "Mesa 20", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } }
]

NÃƒO RETORNA mesas do Bar (ID 2) nem Room Service (ID 3)

4.3. CENÃRIO 2: LOGIN COMO ADMIN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

POST /api/auth/login
{
  "username": "admin",
  "password": "admin123"
}

TOKEN DECODIFICADO:
{
  "sub": "admin",
  "roles": "ROLE_ADMIN",
  "nome": "Administrador",
  "unidadeAtendimentoId": null,  â† ADMIN nÃ£o tem unidade especÃ­fica
  "iat": 1708462800,
  "exp": 1708549200
}

GET /api/unidades-consumo/minhas
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

RESPONSE: Retorna TODAS as mesas (visÃ£o global)
[
  { "id": 10, "referencia": "Mesa 10", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } },
  { "id": 15, "referencia": "Mesa 15", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } },
  { "id": 20, "referencia": "Mesa 20", "unidadeAtendimento": { "id": 1, "nome": "Restaurante Principal" } },
  { "id": 5, "referencia": "Mesa 5", "unidadeAtendimento": { "id": 2, "nome": "Bar Lounge" } },
  { "id": 101, "referencia": "Quarto 101", "unidadeAtendimento": { "id": 3, "nome": "Room Service" } }
]

4.4. CENÃRIO 3: ATUALIZAR HEADER DA PÃGINA
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Frontend ajusta tÃ­tulo baseado em role:

const token = localStorage.getItem('token')
const decoded = jwtDecode(token)

if (decoded.roles?.includes('ROLE_ADMIN')) {
  pageTitle = 'GestÃ£o de Pedidos - VisÃ£o Global'
  subtitle = 'Todas as unidades de atendimento'
} else if (decoded.unidadeAtendimentoId) {
  // Busca nome da unidade
  const unidade = await getUnidadeAtendimento(decoded.unidadeAtendimentoId)
  pageTitle = `GestÃ£o de Pedidos - ${unidade.nome}`
  subtitle = `${unidadesAbertas} unidades abertas`
}

RESULTADO VISUAL:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GestÃ£o de Pedidos - Restaurante Principal               â”‚
â”‚ 3 unidades abertas                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Mesa 10 - SalÃ£o Principal  â”‚ 0,00 Kz â”‚ Pago â”‚ 0 pedido(s)â”‚
â”‚ Mesa 15 - SalÃ£o Principal  â”‚ 0,00 Kz â”‚ Pago â”‚ 0 pedido(s)â”‚
â”‚ Mesa 20 - Esplanada        â”‚ 0,00 Kz â”‚ Pago â”‚ 0 pedido(s)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

vs ADMIN:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GestÃ£o de Pedidos - VisÃ£o Global                        â”‚
â”‚ Todas as unidades de atendimento                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Filtros] UnidadeAtendimento: [Todas â–¼]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
5. ESTRUTURA DE DADOS
================================================================================

5.1. RELACIONAMENTOS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

UnidadeAtendimento (1) â†â”€â”€â”€â”€ (N) Atendente
                       â”‚
                       â””â”€â”€â”€â”€â†’ (N) UnidadeDeConsumo

Exemplo:
UnidadeAtendimento: "Restaurante Principal" (ID: 1)
  â”œâ”€ Atendente: JoÃ£o Silva (GERENTE) â†’ unidadeAtendimentoId = 1
  â”œâ”€ Atendente: Maria Santos (ATENDENTE) â†’ unidadeAtendimentoId = 1
  â”œâ”€ UnidadeDeConsumo: Mesa 10 â†’ unidadeAtendimentoId = 1
  â”œâ”€ UnidadeDeConsumo: Mesa 15 â†’ unidadeAtendimentoId = 1
  â””â”€ UnidadeDeConsumo: Mesa 20 â†’ unidadeAtendimentoId = 1

UnidadeAtendimento: "Bar Lounge" (ID: 2)
  â”œâ”€ Atendente: Carlos Mendes (GERENTE) â†’ unidadeAtendimentoId = 2
  â”œâ”€ UnidadeDeConsumo: Mesa 5 â†’ unidadeAtendimentoId = 2
  â””â”€ UnidadeDeConsumo: Mesa 8 â†’ unidadeAtendimentoId = 2

5.2. TABELA ATENDENTES (APÃ“S MIGRATION)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ nome         â”‚ telefone          â”‚ tipo_usuario â”‚ unidade_atendimento_id    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ JoÃ£o Silva   â”‚ +244923456789     â”‚ GERENTE      â”‚ 1 (Restaurante Principal) â”‚
â”‚ 2  â”‚ Maria Santos â”‚ +244923111222     â”‚ ATENDENTE    â”‚ 1 (Restaurante Principal) â”‚
â”‚ 3  â”‚ Carlos Mendesâ”‚ +244923333444     â”‚ GERENTE      â”‚ 2 (Bar Lounge)            â”‚
â”‚ 4  â”‚ Ana Costa    â”‚ +244923555666     â”‚ ATENDENTE    â”‚ 3 (Room Service)          â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
6. TESTES E VALIDAÃ‡ÃƒO
================================================================================

6.1. CHECKLIST DE TESTES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Backend:
â–¡ CompilaÃ§Ã£o: mvn clean compile (âœ… PASSOU)
â–¡ Login atendente gera token com unidadeAtendimentoId
â–¡ ExtraÃ§Ã£o de unidadeAtendimentoId do token funciona
â–¡ Endpoint /minhas retorna todas unidades para ADMIN
â–¡ Endpoint /minhas filtra por unidadeAtendimentoId para GERENTE
â–¡ ValidaÃ§Ã£o de acesso: GERENTE nÃ£o acessa outras unidades

Frontend:
â–¡ Detecta role corretamente (ADMIN vs GERENTE)
â–¡ Chama endpoint /minhas em vez de endpoint global
â–¡ Exibe tÃ­tulo correto baseado em contexto
â–¡ NÃ£o mostra filtro de UnidadeAtendimento para GERENTE
â–¡ Mostra filtro de UnidadeAtendimento para ADMIN

Database:
â–¡ Migration V006 executa sem erros
â–¡ Coluna unidade_atendimento_id criada
â–¡ Foreign key constraint criada
â–¡ Ãndice criado

6.2. COMANDOS DE TESTE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# 1. Compilar
mvn clean compile -DskipTests

# 2. Executar testes unitÃ¡rios
mvn test -Dtest=UnidadeDeConsumoServiceTest

# 3. Executar aplicaÃ§Ã£o
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 4. Testar endpoint (GERENTE)
curl -X POST http://localhost:8080/api/auth/atendente/login \
  -H "Content-Type: application/json" \
  -d '{"telefone": "+244923456789", "senha": "senha123"}'

# Copiar token da resposta e usar:
curl -X GET http://localhost:8080/api/unidades-consumo/minhas \
  -H "Authorization: Bearer <TOKEN>"

# 5. Testar endpoint (ADMIN)
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'

curl -X GET http://localhost:8080/api/unidades-consumo/minhas \
  -H "Authorization: Bearer <TOKEN>"

================================================================================
7. PRÃ“XIMOS PASSOS
================================================================================

7.1. BACKEND (OPCIONAL - MELHORIAS)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â–¡ ValidaÃ§Ã£o em outros services:
  - PedidoService: validar acesso ao criar/editar pedido
  - SubPedidoService: validar acesso ao entregar item
  - RelatorioService: filtrar relatÃ³rios por unidade

â–¡ Endpoint para ADMIN atuar como gerente de qualquer unidade:
  GET /api/unidades-consumo/por-unidade/{unidadeId}?admin-mode=true

â–¡ Auditoria: registrar qual atendente criou/modificou registro

7.2. FRONTEND (OBRIGATÃ“RIO)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Detectar role no login e armazenar contexto
âœ… Ajustar chamada de API para usar /minhas
âœ… Atualizar tÃ­tulo da pÃ¡gina baseado em role
âœ… Ocultar filtro de UnidadeAtendimento para GERENTE
âœ… Manter filtro de UnidadeAtendimento para ADMIN

7.3. DADOS (OBRIGATÃ“RIO)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Executar migration V006
âœ… Popular campo unidade_atendimento_id para atendentes existentes:
   UPDATE atendentes SET unidade_atendimento_id = 1 WHERE tipo_usuario = 'GERENTE' AND nome = 'JoÃ£o Silva';
   UPDATE atendentes SET unidade_atendimento_id = 1 WHERE tipo_usuario = 'ATENDENTE' AND nome = 'Maria Santos';

7.4. DOCUMENTAÃ‡ÃƒO (CONCLUÃDO)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Atualizar INSTRUCOES_FRONTEND_PAGINA_PEDIDOS.txt
âœ… Criar REFATORACAO_HIERARQUIA_UNIDADES.txt (este arquivo)
âœ… Atualizar API_EXAMPLES.md com novos endpoints

================================================================================
8. IMPACTO E BREAKING CHANGES
================================================================================

8.1. COMPATIBILIDADE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… RETROCOMPATÃVEL:
- Campo unidade_atendimento_id Ã© NULLABLE
- Atendentes existentes continuam funcionando (unidadeAtendimentoId = null)
- Token JWT sem unidadeAtendimentoId ainda funciona
- Endpoint antigo GET /api/unidades-consumo continua existindo

âš ï¸ DEGRADAÃ‡ÃƒO GRADUAL:
- Atendentes sem unidadeAtendimentoId verÃ£o TODAS as unidades (como ADMIN)
- Recomendado: popular campo para todos os atendentes

8.2. MIGRAÃ‡ÃƒO DE DADOS EXISTENTES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

-- Exemplo: atribuir todos GERENTE/ATENDENTE Ã  primeira UnidadeAtendimento
UPDATE atendentes 
SET unidade_atendimento_id = (SELECT MIN(id) FROM unidades_atendimento)
WHERE unidade_atendimento_id IS NULL 
  AND tipo_usuario IN ('GERENTE', 'ATENDENTE');

-- Ou manualmente para cada atendente:
UPDATE atendentes SET unidade_atendimento_id = 1 WHERE id = 1; -- JoÃ£o Silva â†’ Restaurante
UPDATE atendentes SET unidade_atendimento_id = 2 WHERE id = 3; -- Carlos â†’ Bar

================================================================================
9. RESUMO EXECUTIVO
================================================================================

âœ… IMPLEMENTADO:
- Relacionamento Atendente â†” UnidadeAtendimento
- Token JWT contÃ©m unidadeAtendimentoId
- Endpoint GET /api/unidades-consumo/minhas com filtro automÃ¡tico
- LÃ³gica de permissÃµes: ADMIN (global) vs GERENTE (unit-scoped)

ğŸ“Š MÃ‰TRICAS:
- Arquivos modificados: 5
- Linhas adicionadas: ~150
- Linhas modificadas: ~30
- Migration SQL: 1 arquivo
- Compilation: âœ… SUCCESS
- Breaking changes: âŒ Nenhum

ğŸ¯ BENEFÃCIOS:
- Gerentes veem apenas suas unidades (isolamento operacional)
- ADMIN mantÃ©m visÃ£o global (supervisÃ£o)
- SeguranÃ§a: validaÃ§Ã£o automÃ¡tica de acesso por token
- Performance: queries filtradas por unidade
- Escalabilidade: suporta mÃºltiplas unidades de atendimento

ğŸ”§ AÃ‡Ã•ES NECESSÃRIAS:
1. âœ… Compilar cÃ³digo (CONCLUÃDO)
2. â³ Executar migration V006
3. â³ Popular campo unidade_atendimento_id
4. â³ Atualizar frontend para usar endpoint /minhas
5. â³ Testar fluxos ADMIN e GERENTE

================================================================================
FIM DO DOCUMENTO
================================================================================
